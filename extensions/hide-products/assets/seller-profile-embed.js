/**
 * * This file is used to manage SPA-like Shopify themes that work by swapping changed DOM content
 * * instead of reloading the page.
 * * Due to the SPA-like nature of these themes, scripts won't run on the initial page load as they will be blocked by the browser.
 * * Hence, the Vue application won't get created and mounted. 
 * * This file is used to fetch the necessary dependancies and trigger the mounting of the Vue application from the seller-profile.js file.
 * * It also handles the scenario where themes cache pages(resulting in stale mount flags) and the remounting of the Vue application in different other scenarios like browser back/forward button, hashchange event, load event, etc.
 *
 *
 */

/**
 * ! Please minify this file and replace the seller-profile-embed-min.js file after editing.
 */

window.onload = () => {
    function loadScript(src) {
        return new Promise((resolve, reject) => {
        // Remove existing scripts with the same src
        const existing = document.querySelectorAll(`script[src="${src}"]`);
        existing.forEach(script => script.remove());
        
        const s = document.createElement('script');
        s.src = src;
        s.async = false;            // preserve execution order
        s.onload  = () => resolve(src);
        s.onerror = () => reject(new Error(`Failed to load ${src}`));
        document.head.appendChild(s);
    })}

    function dependenciesReady() {

        return !!(
        window.Vue &&
        window.VueRouter &&
        window.PrimeVue &&
        window.VueI18n
        );
    }

    function waitForDependencies(callback) {
        if (dependenciesReady() && typeof mountSellerProfile === 'function') {
            callback();
            return;
        }

        const deps = [
            'https://unpkg.com/vue@3.5.1/dist/vue.global.prod.js',
            'https://unpkg.com/vue-router@4.6.0/dist/vue-router.global.prod.js',
            'https://unpkg.com/vue-i18n@9/dist/vue-i18n.global.prod.js',
            'https://unpkg.com/primevue/umd/primevue.min.js',
            'https://unpkg.com/@primevue/themes/umd/aura.min.js',
        ];

        // Add the seller profile script(seller-profile.js) to the dependencies.
        const sellerProfileScript = document.getElementById('st-seller-profile-script');

        if (sellerProfileScript?.src)
            deps.push(sellerProfileScript.src); // The src is generated by Shopify.

        Promise.all(deps.map(loadScript))
        .then(() => {
            callback();
        })
        .catch(err => {
            console.error('Dependency load error:', err);
        });
    }

    // Validate if app is actually mounted and functional (handles cached pages with stale flags)
    function isAppActuallyMounted() {
        const el = document.getElementById("seller-profile-app");
        if (!el) return false;
        
        // Check both the flag and the actual app instance
        const hasFlag = el.__mounted === true;
        const hasInstance = window.__sellerProfileAppInstance !== null && window.__sellerProfileAppInstance !== undefined;
        
        // If DOM says mounted but no instance (cached page scenario), it's not actually mounted
        if (hasFlag && !hasInstance) {
            console.warn('Cached page detected: DOM says mounted but app instance missing. Resetting...');
            el.__mounted = false;
            return false;
        }
        
        // Check if Vue has actually rendered content (not just mounted but empty)
        // The app should render a container with id "st-ext-seller-profile-container"
        const hasVueContent = el.children.length > 0 && 
                            (el.querySelector('#st-ext-seller-profile-container') !== null ||
                            el.querySelector('.st-ext-container') !== null ||
                            el.__vue_app__ !== undefined);
        
        // If flag and instance exist but no content rendered, it's not actually functional
        if (hasFlag && hasInstance && !hasVueContent) {
            console.warn('App instance exists but no content rendered. Resetting for remount...');
            // Try to unmount if possible before clearing
            try {
                const appInstance = window.__sellerProfileAppInstance;
                if (appInstance && typeof appInstance.unmount === 'function') {
                    appInstance.unmount();
                }
            } catch (e) {
                console.warn('Error unmounting app:', e);
            }
            // Clear the state
            el.__mounted = false;
            window.__sellerProfileAppInstance = null;
            return false;
        }
        
        return hasFlag && hasInstance && hasVueContent;
    }

    // Function to attempt mounting if conditions are met
    function tryMountSellerProfile() {
        const el = document.getElementById("seller-profile-app");
        
        // Skip if element doesn't exist or not on seller-profile route
        if (!el) {
            return;
        }
        
        // If already properly mounted, skip (Vue Router will handle navigation)
        if (isAppActuallyMounted()) {
            return;
        }
        
        waitForDependencies(() => {
            // Defined in seller-profile.js
            if (typeof mountSellerProfile === 'function') {
                mountSellerProfile();
            }
        });
    }

    // Prevent duplicate initialization (handles page caching where script runs multiple times)
    if (window.__sellerProfileEmbedInitialized) {
        console.log('Seller profile embed already initialized, skipping duplicate setup');
    } else {
        window.__sellerProfileEmbedInitialized = true;
        
        const observer = new MutationObserver((mutationList, observer) => {
            tryMountSellerProfile();
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true
        });

        // Handle browser back/forward button
        // Use named function to allow removal if needed (though we prevent duplicates above)
        function handlePopState(event) {
            // Small delay to ensure DOM is ready after navigation
            setTimeout(() => {
                tryMountSellerProfile();
            }, 100);
        }
        
        function handleHashChange(event) {
            setTimeout(() => {
                tryMountSellerProfile();
            }, 100);
        }
        
        window.addEventListener('popstate', handlePopState);
        window.addEventListener('hashchange', handleHashChange);

        // Initial check on page load
        // Also validate cached pages that might have stale mount flags
        // function initialCheck() {
        //     // Validate existing mount state first (handles cached pages)
        //     console.log('Calling Initial Check')
        //     if (isAppActuallyMounted()) {
        //     } else {
        //         tryMountSellerProfile();
        //     }
        // }
        
        // window.addEventListener('load', () => {
        //     console.log('Loaded everything')
        //     initialCheck()
        // });
    }
}